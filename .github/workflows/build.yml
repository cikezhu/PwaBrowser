name: Android CI

# 触发器配置
on:
  # 1. 手动触发（网页操作）
  workflow_dispatch:
    inputs:
      version_tag:
        description: '版本标签 (例如: v1.0.0)'
        required: true
        type: string
        default: 'v1.0.0'
      create_release:
        description: '是否创建GitHub Release'
        required: false
        type: boolean
        default: true
      release_notes:
        description: '发布说明'
        required: false
        type: string
        default: ''

  # 2. 自动触发：推送标签时
  push:
    tags:
      - 'v*'
  
  # 3. 自动触发：拉取请求到主分支时
  pull_request:
    branches: [ main, master ]

# 工作流权限
permissions:
  contents: write  # 允许创建标签和发布
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取所有历史记录，便于打标签
          
      # 如果是手动触发，创建标签
      - name: 创建Git标签（仅手动触发）
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG_NAME="${{ github.event.inputs.version_tag }}"
          
          # 检查标签格式
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "❌ 标签格式错误，请使用类似 v1.0.0 的格式"
            exit 1
          fi
          
          # 检查标签是否已存在
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "⚠️  标签 $TAG_NAME 已存在，使用现有标签"
          else
            # 创建新标签
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag $TAG_NAME
            git push origin $TAG_NAME
            echo "✅ 已创建并推送标签: $TAG_NAME"
          fi
          
          # 设置环境变量供后续步骤使用
          echo "RELEASE_TAG=$TAG_NAME" >> $GITHUB_ENV
          echo "SHOULD_CREATE_RELEASE=${{ github.event.inputs.create_release }}" >> $GITHUB_ENV
          echo "RELEASE_NOTES=${{ github.event.inputs.release_notes }}" >> $GITHUB_ENV
          
      # 设置JDK环境
      - name: 设置JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          
      # 获取打包秘钥
      - name: 检出Android Keystore
        uses: actions/checkout@v3
        with:
          repository: cikezhu/android-keystore
          token: ${{ secrets.TOKEN }}
          path: keystore
          
      # 获取版本信息
      - name: 确定版本标签
        id: version_info
        run: |
          # 如果是手动触发，使用环境变量中的标签
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "当前标签: ${{ env.RELEASE_TAG }}"
            echo "tag_name=${{ env.RELEASE_TAG }}" >> $GITHUB_OUTPUT
            echo "create_release=${{ env.SHOULD_CREATE_RELEASE }}" >> $GITHUB_OUTPUT
            
            # 获取上一个标签
            if git describe --tags --abbrev=0 "${{ env.RELEASE_TAG }}"^ 2>/dev/null; then
              OLD_TAG=$(git describe --tags --abbrev=0 "${{ env.RELEASE_TAG }}"^)
            else
              OLD_TAG=""
            fi
          else
            # 如果是自动触发，使用当前标签
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "当前标签: $TAG_NAME"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "create_release=true" >> $GITHUB_OUTPUT
            
            # 获取上一个标签
            if git rev-list --tags --skip=1 --max-count=1 2>/dev/null; then
              OLD_COMMIT=$(git rev-list --tags --skip=1 --max-count=1)
              OLD_TAG=$(git describe --tags --abbrev=0 $OLD_COMMIT 2>/dev/null || echo "")
            else
              OLD_TAG=""
            fi
          fi
          
          echo "上一个标签: $OLD_TAG"
          echo "old_tag=$OLD_TAG" >> $GITHUB_OUTPUT
          
      # 生成更新日志
      - name: 生成更新日志
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}
          base-ref: ${{ steps.version_info.outputs.old_tag }}
          
      # 构建APK
      - name: 使用Gradle构建
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease
          
      # 创建Release（手动触发时根据设置决定，自动触发时总是创建）
      - name: 创建GitHub Release
        id: create_release
        if: steps.version_info.outputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.tag_name }}
          name: Release ${{ steps.version_info.outputs.tag_name }}
          body: |
            # 发布说明
            
            ${{ env.RELEASE_NOTES }}
            
            ## 更新日志
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            *构建信息*
            - 触发方式: ${{ github.event_name }}
            - 触发时间: ${{ github.event.created_at }}
            - Commit: ${{ github.sha }}
          draft: false
          prerelease: false
          generate_release_notes: false
          
      # 上传APK到Release
      - name: 上传Release资源
        if: steps.version_info.outputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.tag_name }}
          files: |
            app/build/outputs/apk/release/app-release.apk
          append_body: false
          
      # 归档构建产物
      - name: 归档生产构建产物
        uses: actions/upload-artifact@v3
        with:
          name: android-build-${{ steps.version_info.outputs.tag_name }}
          path: |
            app/build/outputs/apk/
            app/build/outputs/mapping/
